# Linker Scripts

The provided linker performs most of the actual code generation of the
compiler. It takes a description of the execution environment, as well as a
number of Intermediate Representation object files generated by the frontend,
and generates one or more ASM files corresponding to various regions of the
program. The programmer can then combine these ASM files into a loadable
binary image.

This document describes the TOML-based language used to describe the
execution environment and how the C inputs relate to it.

Linker scripts are comprised of two main arrays of declarations:

* Memory, which describes regions of RAM available for general use by the
  compiler.

* Sections, which describe where program code and data initializers will be
  located when they are referenced at runtime.

All addresses are given in hexadecimal, without prefix. For example, `47F`
refers to address 0x47F.

Text in brackets, `<like this>`, are syntactic variables referring to values
named by the text in the brackets. For example, `<address>` refers to some
address.

## Memory

Memory is an array of ranges available for general use by the compiler. The
beginning of the range (inclusive) is given by `from`, and the end of the
range (exclusive) is given by `to`.

For example:

```toml
[[memory]]
from = "80"
to = "200"

[[memory]]
from = "47F"
to = "700"
```

The above config allows the compiler to use any address 0x80, address 0x199,
and any address in between. It may also use 0x47F, 0x6FF, and any address in
between.

## Sections

A section is a contiguous region of code and data initializers. Each section
must have a `name` and produces `<name>.asm` as output. The object files
placed in each section are given by the `inputs` array.

The address space that the section occupies at runtime may be specified using
`from` and `to`, with the same semantics as above. The given ranges need not
be contained in a memory declaration.

If address ranges are not provided, the section is automatically allocated to
part of some memory declaration. Automatic allocations cannot span memory
declarations or use ranges explicitly allocated to other sections. I If the
automatically allocated sections cannot be made to all fit in the available
memory, the linker signals an error.

The memory used can be indicated to be ROM by setting `type` to `"ROM"`. If
any mutable or volatile objects with static lifetime and an initializer occur
within the section, the compiler will generate a function with the name
`__<name>_init`. Calling this function copies initialization data from the
ROM section to the RAM address allocated for the mutable objects. This must
be called before any code that refers to the variable, since all such code
will expect the object to be present and initialized at its RAM address. The
function takes no arguments, has no return value, and is externally visible.